# 0x06 内核同步方法
## 1. 原子操作
原子操作就是不能被分割的指令。linux提供了两组原子操作的接口：

* 一组针对整数（atomic_t，asm/atomic.h，编译器不会针对该类型优化）进行操作，atomic_inc，atomic_dec等等，64位上有atomic64_t。
* 一组针对单独的位进行操作，asm/bitops.h。

## 2. 自旋锁
 自旋锁最多只能被一个线程持有，如果一个线程师徒获得一个已经被持有的自旋锁，那么该线程就会一直进行忙循环-》旋转-》等待锁重新可用。自旋比较浪费时间！！！所以自旋锁不应该被长时间持有。

自旋锁的实现和体系结构密切相关。linux/spinloc.h。

```
DEFINE_SPINLICK(mr_lock);
spin_lock(&mr_lock);
/* Critical Section */
spin_unlock(&mr_lock);
```

Linux内核中的自旋锁不可递归！小心自死锁！

自旋锁可以用在中断处理程序中（信号量不可以，他会导致睡眠， 这是 `血的教训！` ，前几天就遇到一个网络协议栈中信号量导致内核调度问题 ）。中断程序中在获取锁之前先要禁止当前处理器上的中断spin_lock_irqsave、spin_unlock_irqstore。

创建一个自旋锁：spin_lock_init。

spin_lock_bh用于获取制定锁，同时它会禁止所有下半部的执行，spin_unlock_bh相反。

## 3. 读写锁




